<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dice Roller Multiplayer</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script
			  src="https://code.jquery.com/jquery-3.7.1.min.js"
			  integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
			  crossorigin="anonymous"></script>
<script src="https://cdn.socket.io/4.8.1/socket.io.min.js" integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+" crossorigin="anonymous"></script>      
</head>
<body class="bg-light">

<div class="container mt-5">

  <!-- Stage 1: Create or Join -->
  <div id="game-setup" class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow-lg rounded-3">
        <div class="card-body">
          <h3 class="card-title text-center mb-4">ðŸŽ® Game Setup</h3>

          <!-- Create Game -->
          <form id="create-join-game-form" class="mb-4">
            <h5>Create or Join Game</h5>
            <div class="mb-3">
              <label for="playerName" class="form-label">Your Name</label>
              <input type="text" class="form-control" id="playerName" name="playerName" required>
            </div>            
            <div class="mb-3">
              <label for="gameId" class="form-label">Game ID</label>
              <input type="text" class="form-control" id="gameId" name="gameId" maxlength="8" required>
            </div>
            <button type="submit" class="btn btn-success w-100">Create Game</button>
          </form>

          <hr>

        </div>
      </div>
    </div>
  </div>

  <!-- Stage 2: Dice Roller -->
  <div id="dice-roller" class="row justify-content-center d-none">
    <div class="col-md-6">
      <div class="card shadow-lg rounded-3">
        <div class="card-body">
          <h3 class="card-title text-center mb-4">ðŸŽ² Dice Roller</h3>
          <div class="alert alert-info text-center mb-3" id="game-info"></div>

          <div class="mb-2">
            <strong>Players in game:</strong> <span id="player-list"></span>
          </div>

          <form id="dice-form">
            <div class="mb-3">
              <label for="numDice" class="form-label">Number of Dice</label>
              <input type="number" class="form-control" id="numDice" name="numDice" min="1" value="1" required>
            </div>
            <div class="mb-3">
              <label for="numSides" class="form-label">Number of Sides</label>
              <input type="number" class="form-control" id="numSides" name="numSides" min="2" value="6" required>
            </div>
            <div class="mb-3">
              <label for="keep" class="form-label">Keep (number of highest rolls, optional)</label>
              <input type="number" class="form-control" id="keep" name="keep" min="1" placeholder="Leave empty to keep all">
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="allowExplosion" name="allowExplosion">
              <label class="form-check-label" for="allowExplosion">
                Allow Explosion
              </label>
            </div>
            <button type="submit" class="btn btn-primary w-100">Roll Dice</button>
          </form>

          <hr>
          <div class="d-flex justify-content-between align-items-start">
            <div id="results"></div>
          </div>

        </div>
      </div>
    </div>
  </div>

</div>

<script>
$(document).ready(function(){

    console.log("Script loaded and ready");

    let currentGameId = null;
    let currentPlayer = null;

    // Connect to Socket.IO server
    const socket = io("/", { transports: ["websocket"] });

    socket.on("connect", () => console.log("Socket connected:", socket.id));
    socket.on("connect_error", (err) => console.error("Socket connection error:", err));

    // Display last roll
    function resultsDisplay(data){
        if(!data.lastRequest || !data.lastRequest.results) {
            $("#results").html("<p>No rolls yet.</p>");
            return;
        }

        let resultsHtml = data.lastRequest.results.map((r,i)=>{
            let text = (r.exploded && Array.isArray(r.exploded) && r.exploded.length > 1)
                      ? `${r.total} (${r.exploded.join('+')})`
                      : `${r.total}`;

            if(data.lastRequest.kept_indices && data.lastRequest.kept_indices.includes(i)){
                text = `<strong>${text}</strong>`;
            }
            return text;
        }).join(", ");

        $("#results").html(
            `<h5>Latest Roll by ${data.lastRequest.player}:</h5>
            <p>${resultsHtml}</p>
            <h6>Total: ${data.lastRequest.sum}</h6>`
        );
    }

    // Update game state
    socket.on("game_state", function(data){
        if(!data || !data.players) return;

        let playersHtml = data.players.map((p,index)=>{
            if(index===0) return `<strong>${p} (Creator)</strong>`;
            return p;
        }).join(", ");
        $("#player-list").html(playersHtml);

        resultsDisplay(data);
        if(currentGameId) $("#game-info").text(`Game ID: ${currentGameId}`);
    });

    // Create game
    $("#create-join-game-form").on("submit", function(e){
        e.preventDefault();
        const playerName = $("#playerName").val();
        const gameId = $("#gameId").val();

        console.log("Create game clicked:", playerName, gameId);
        socket.emit("create_game", { playerName, gameId });
    });

    // Roll dice
    $("#dice-form").on("submit", function(e){
        e.preventDefault();
        const numDice = parseInt($("#numDice").val());
        const numSides = parseInt($("#numSides").val());
        const allowExplosion = $("#allowExplosion").is(":checked");
        const keep = parseInt($("#keep").val()) || null;  // null = keep all

        console.log("Roll dice:", currentPlayer, currentGameId, numDice, numSides, allowExplosion, keep);
        socket.emit("roll_dice", {
            playerName: currentPlayer,
            gameId: currentGameId,
            numDice,
            numSides,
            allowExplosion,
            keep
        });
    });

    // Handle confirmations
    socket.on("game_joined", function(data){
        console.log("Game joined:", data);
        currentGameId = data.gameId;
        currentPlayer = data.playerName;

        $("#game-setup").addClass("d-none");
        $("#dice-roller").removeClass("d-none");
    });

});
</script>



</body>
</html>
