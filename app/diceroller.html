<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dice Roller Multiplayer</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-light">

<div class="container mt-5">

  <!-- Stage 1: Create or Join -->
  <div id="game-setup" class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow-lg rounded-3">
        <div class="card-body">
          <h3 class="card-title text-center mb-4">ðŸŽ® Game Setup</h3>

          <!-- Create Game -->
          <form id="create-game-form" class="mb-4">
            <h5>Create New Game</h5>
            <div class="mb-3">
              <label for="creatorName" class="form-label">Your Name</label>
              <input type="text" class="form-control" id="creatorName" name="creatorName" required>
            </div>
            <div class="mb-3">
              <label for="numPlayers" class="form-label">Number of Players</label>
              <input type="number" class="form-control" id="numPlayers" name="numPlayers" min="2" required>
            </div>
            <button type="submit" class="btn btn-success w-100">Create Game</button>
          </form>

          <hr>

          <!-- Join Game -->
          <form id="join-game-form">
            <h5>Join Existing Game</h5>
            <div class="mb-3">
              <label for="playerName" class="form-label">Your Name</label>
              <input type="text" class="form-control" id="playerName" name="playerName" required>
            </div>
            <div class="mb-3">
              <label for="gameId" class="form-label">Game ID</label>
              <input type="text" class="form-control" id="gameId" name="gameId" maxlength="8" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Join Game</button>
          </form>

        </div>
      </div>
    </div>
  </div>

  <!-- Stage 2: Dice Roller -->
  <div id="dice-roller" class="row justify-content-center d-none">
    <div class="col-md-6">
      <div class="card shadow-lg rounded-3">
        <div class="card-body">
          <h3 class="card-title text-center mb-4">ðŸŽ² Dice Roller</h3>
          <div class="alert alert-info text-center mb-3" id="game-info"></div>

          <div class="mb-2">
            <strong>Players in game:</strong> <span id="player-list"></span>
          </div>

          <form id="dice-form">
            <div class="mb-3">
              <label for="numDice" class="form-label">Number of Dice</label>
              <input type="number" class="form-control" id="numDice" name="numDice" min="1" value="1" required>
            </div>
            <div class="mb-3">
              <label for="numSides" class="form-label">Number of Sides</label>
              <input type="number" class="form-control" id="numSides" name="numSides" min="2" value="6" required>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="allowExplosion" name="allowExplosion">
              <label class="form-check-label" for="allowExplosion">
                Allow Explosion
              </label>
            </div>
            <button type="submit" class="btn btn-primary w-100">Roll Dice</button>
          </form>

          <hr>
          <div class="d-flex justify-content-between align-items-start">
            <div id="results"></div>
            <button id="refresh-game" class="btn btn-secondary btn-sm">Refresh</button>
          </div>

        </div>
      </div>
    </div>
  </div>

</div>

<script>
let currentGameId = null;
let currentPlayer = null;
let refreshInterval = null;

// Fetch and display current game state safely
function refreshGameState() {
    if (!currentGameId) return;

    $.getJSON("api/get_game_state.php", { gameId: currentGameId })
     .done(function(data){
        if(data.success){
            // Display players, mark creator
            let playersHtml = data.players.map((p, index) => {
                if(index === 0) return `<strong>${p} (Creator)</strong>`;
                return p;
            }).join(", ");
            $("#player-list").html(playersHtml);

            // Show last roll safely
            if(data.lastRequest && data.lastRequest.results && data.lastRequest.results.length){
                let resultsHtml = data.lastRequest.results.map(r => {
                    if(r.exploded && r.exploded.length > 1){
                        return `${r.total} (${r.exploded.join('+')})`;
                    } else {
                        return r.total;
                    }
                }).join(", ");

                $("#results").html(
                    `<h5>Latest Roll by ${data.lastRequest.player}:</h5>
                     <p>${resultsHtml}</p>
                     <h6>Total: ${data.lastRequest.sum}</h6>`
                );
            } else {
                $("#results").html("<p>No rolls yet.</p>");
            }
        } else {
            $("#results").html(`<div class="alert alert-danger">${data.message}</div>`);
        }
     })
     .fail(function(xhr, status, error){
        $("#results").html(`<div class="alert alert-danger">Error fetching game state</div>`);
        console.error("Error:", error, xhr.responseText);
     });
}

// Start / stop auto-refresh
function startAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(refreshGameState, 2000);
}
function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

$(document).ready(function(){

  // Create game
  $("#create-game-form").on("submit", function(e){
    e.preventDefault();
    const creatorName = $("#creatorName").val();
    $.post("api/create_game.php", { 
        numPlayers: $("#numPlayers").val(),
        creatorName: creatorName
    }, function(data){
        if(data.success){
            currentGameId = data.gameId;
            currentPlayer = creatorName;
            $("#game-info").text("Game ID: " + currentGameId + " (Waiting for players...)");
            $("#game-setup").addClass("d-none");
            $("#dice-roller").removeClass("d-none");
            startAutoRefresh();
        } else {
            alert(data.message || "Error creating game.");
        }
    }, "json").fail(function(xhr, status, error){
        console.error("AJAX failed:", status, error, xhr.responseText);
    });
  });

  // Join game
  $("#join-game-form").on("submit", function(e){
    e.preventDefault();
    $.post("api/join_game.php", { 
        playerName: $("#playerName").val(), 
        gameId: $("#gameId").val() 
    }, function(data){
        if(data.success){
            currentGameId = data.gameId;
            currentPlayer = data.playerName;
            $("#game-info").text("Joined Game ID: " + currentGameId + " as " + currentPlayer);
            $("#game-setup").addClass("d-none");
            $("#dice-roller").removeClass("d-none");
            startAutoRefresh();
        } else {
            alert(data.message || "Error joining game.");
        }
    }, "json").fail(function(xhr, status, error){
        console.error("AJAX failed:", status, error, xhr.responseText);
    });
  });

  // Dice roller submit
  $("#dice-form").on("submit", function(e){
    e.preventDefault();
    console.log("Rolling dice for", currentPlayer, "in game", currentGameId);

    $.post("api/roll_dice.php", { 
        numDice: $("#numDice").val(),
        numSides: $("#numSides").val(),
        allowExplosion: $("#allowExplosion").is(":checked") ? 1 : 0,
        gameId: currentGameId,
        playerName: currentPlayer
    }, function(data){
        console.log("Roll response:", data);

        if(data.success){
            refreshGameState();
        } else {
            $("#results").html(`<div class="alert alert-danger">${data.message || 'Error rolling dice.'}</div>`);
        }
    }, "json").fail(function(xhr, status, error){
        console.error("AJAX failed:", status, error, xhr.responseText);
        $("#results").html(`<div class="alert alert-danger">AJAX error rolling dice.</div>`);
    });
  });

  // Manual refresh button
  $("#refresh-game").on("click", refreshGameState);

});
</script>

</body>
</html>
